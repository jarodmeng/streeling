---
title: Stars and bars and prisoners
author: Jarod Meng
date: '2017-09-19'
categories:
  - Maths
tags:
  - combinatorics
slug: stars-and-bars-and-prisoners
---

One of my friends posted an interesting brain teaser on WeChat. It was in Mandarin, so here is a loose translation of the question.

> Suppose there are 100 prisoners. All of them are in solitary confinement so they cannot talk to each other at all. The warden has designed a "game". He prepares an empty room with only a lamp inside. The lamp is initially switched off. Each time he takes a single prisoner into the room. The prisoner can choose to turn on/off the lamp and do nothing else. Each prisoner can be taken multiple times. The "game" is that each time before a prisoner is about to leave the room, he can make an assertion that all 100 prisoners have been to the room at least once. If the assertion is indeed true, all prisoners are released. If not, all of them are executed. The prisoners can have a meeting to set a strategy. What's the strategy?

My initial approach is to try to use the lamp as a counter since that's the only communication device accessible by all prisoners. That turns out to be very difficult since the lamp is basically just a binary switch with no memory.

Before I spend serious brain power to design a clever way of using the switch to signal the event that all prisoners have been to the room at least once, I thought I should compute the probability of the event itself.

The probability question can be abstracted to a combinatorics problem. That is, if each prisoner has equal probability of being taken to the room and a prisoner can be taken multiple times, how many times the warden needs to take prisoners to the room for every prisoner to have been taken at least once.

More precisely, the prisoners who have been taken to the room after $k$ times form a $k$-element [multiset](https://en.wikipedia.org/wiki/Multiset) from an $n$-element unique set (in this case, $n=100$). The probability can then be computed as **the number of multisets that contain all $n$ elements from the unique set divided by the total number of possible multisets**.

## Combination

Since the order of the prisoners doesn't matter, the problem is a [combination](https://en.wikipedia.org/wiki/Combination) question. In conventional combinations, the number of $k$-combinations of a $n$-element set ($k \leq n$) is equal to the binomial coefficient
${{n}\choose{k}} = \frac{n!}{k!(n-k)!} = \frac{n(n-1)...(n-k+1)}{k(k-1)...1}$. For example, there are ${{3}\choose{2}} = \frac{3 \times 2}{2 \times 1} = 3$ ways to choose a 2-element tuple from a 3-element set $\{A, B, C\}$, namely $(A, B)$, $(A, C)$, and $(B, C)$.

Conventional combinations are drawn without repetition. The 3 tuples in the previous example are all unique sets. However, in our prisoner problem, the same prisoner can be taken more than once, so the binomial coefficient doesn't seem to apply here.

What we need here is a way to [count multisets](https://en.wikipedia.org/wiki/Multiset#Counting_multisets). Formally, the number of multisets of cardinality $k$, with elements taken from a finite set of cardinality $n$, is the multiset coefficient, written as $\left(\!\!{n\choose k}\!\!\right)$.

The value of multiset coefficient can be computed using an equivalent binomial coefficient.

$$\left(\!\!{n\choose k}\!\!\right) = {{n+k-1}\choose{k}} = \frac{(n+k-1)!}{k!(n-1)!}$$

To see this equivalence, one can use a simple technique called [stars and bars](https://en.wikipedia.org/wiki/Stars_and_bars_(combinatorics)).

Suppose 3 elements are drawn with repetition from the set ${1,2}$ of cardinality 2 ($n=2, k=3$). It's not difficult to enumerate all possible multisets because there are only 4 of them: $\{1,1,1\}$, $\{1,1,2\}$, $\{1,2,2\}$, and $\{2,2,2\}$.

We can also represent those multisets in another form.

$\{{\bullet}{\bullet}{\bullet}|\}$, $\{{\bullet}{\bullet}|{\bullet}\}$, $\{{\bullet}|{\bullet}{\bullet}\}$, and $\{|{\bullet}{\bullet}{\bullet}\}$

In this form, all elements are denoted as a dot. Vertical bars are put to divide the dots into bins, with each bin representing an element from the unique set. It's possible to have a bin with no elements which basically means that the particular unique element doesn't have any corresponding elements in the multiset (e.g., the first multiset doesn't have element $2$ and the last multiset doesn't have $1$).

One needs $n-1$ bars to represent a unique set of cardinality $n$. If we count the total number of dots and bars in a $k$-element multiset, it's $k+n-1$. Then the total number of possible $k$-element multisets equals to the total number of ways of placing $n-1$ bars in $k+n-1$ items, which is ${{k+n-1}\choose{n-1}} = {{k+n-1}\choose{k}}$.

## The denominator

Let's return to the original question. What's the probability of all prisoners being taken to the room at least once after the warden takes $k$ times? To compute this probability, we need to compute the total number of possible scenarios which will serve as the denominator.

The total number should equal to $\left(\!\!{100\choose k}\!\!\right)$, for a $k \geq 100$. From the previous section, we can work out $\left(\!\!{100\choose k}\!\!\right) = {{k+100-1}\choose{k}} = {{k+99}\choose{k}}$.

## The numerator

The numerator of the probability is the number of multisets in which all prisoners are present at least once. The trick to compute this number is to divide any such multiset into two parts: one set that contains all 100 prisoners and the other with remaining $k-100$ elements. Then the total number of such multisets equals to $\left(\!\!{100\choose k-100}\!\!\right) = {{100+k-100-1}\choose{100-1}} = {{k-1}\choose{99}}$, for a $k \geq 100$.

## The probability

Once we have both the denominator and numerator, the probability is straightforward to compute.

$$Pr(E) = \frac{{{k-1}\choose{99}}}{{{k+99}\choose{k}}} = \frac{\frac{(k-1)!}{99! \cdot (k-100)!}}{\frac{(k+99)!}{k! \cdot 99!}} = \frac{k!(k-1)!}{(k+99)!(k-100)!}$$

We can plot this probability function for $100 \leq k \leq 200$.

```{r}
Pr <- function(k) {
  choose(k-1, 99)/choose(k+99, k)
}
curve(Pr, from = 100, to = 200, xlab = "k", ylab = "Pr(E)")
```

The plot shows that the probability of getting all prisoners at least once even after the warden takes 200 times is so slim that it's practically 0.

We can extend the possible $k$ values.

```{r}
curve(Pr, from = 100, to = 30000, xlab = "k", ylab = "Pr(E)")
```

For the probability to reach 10%, the warden needs to take nearly 5,000 times. The probability increases a bit faster once $k$ exceeds 5,000, but it still takes about 10,000 times before it gets near 40%.

We can also find out the minimum $k$ that makes the probability greater than 50% (i.e., better than a coin flip).

```{r}
for (k in seq(100, 30000, 1)) {
  if (Pr(k) >= 0.5) {
    print(paste0("It takes ", k, " times for the probability to reach 50%."))
    break
  }
}
```

Assuming that the warden takes 1 prisoner to the room every day, it would take `r round(14283/365, 2)` years for the odds to be better than a random coin flip.

How about 80% probability?

```{r}
for (k in seq(100, 50000, 1)) {
  if (Pr(k) >= 0.8) {
    print(paste0("It takes ", k, " times for the probability to reach 80%."))
    break
  }
}
```

That's `r round(44367/365, 2)` years! If that ever happens, the warden has to be the most dedicated warden in history.